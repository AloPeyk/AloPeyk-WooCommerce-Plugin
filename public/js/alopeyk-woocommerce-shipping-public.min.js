!function(M){"use strict";var A=A||{wcshm:{}};A.wcshm.public={},A.wcshm.public.vars={common:{info:window.awcshm,activeClass:"active",loadingClass:"loading",disabledClass:"disabled",alopeykPrefix:"awcshm-",paymentMethodInput:'input[name="payment_method"]'},maps:{selector:".map-canvas",mapContainerClass:"map-container",destinationLatInput:"#destination_latitude, #_shipping_address_latitude",destinationLngInput:"#destination_longitude, #_shipping_address_longitude",destinationCityInput:"#destination_city, #_shipping_address_location_city",destinationAddressInput:"#destination_address, #_shipping_address_location",destinationNumberInput:"#destination_number, #_shipping_address_number",destinationUnitInput:"#destination_unit, #_shipping_address_unit",shippingAddress1Input:"#shipping_address_1, #_shipping_address_1",shippingAddress2Input:"#shipping_address_2, #_shipping_address_2",billingAddress1Input:"#billing_address_1, #_billing_address_1",billingAddress2Input:"#billing_address_2, #_billing_address_2",shipToDifferentAddressInput:'input[name="ship_to_different_address"]',editAddressButton:"a.edit_address:eq(1)",destinationLocatorMapId:"destination-locator-map",destinationLocatorMapClass:"map-canvas destination-locator-map",destinationLocatorCtaClass:"destination-locator-cta",mapMarkerIconClass:"map-marker-icon",destinationLocatorInputWrapperId:"destination-locator-input-wrapper",destinationLocatorInputWrapperClass:"destination-locator-input-wrapper",destinationLocatorAutocompleteResultsClass:"destination-locator-autocomplete-results",destinationLocatorAutocompleteResultClass:"destination-locator-autocomplete-result",destinationLocatorHiddenableInput:".hide-parent-row",autocompletePlaceholderDataAttr:"autocomplete-placeholder",autocompleteKeyupTimeout:null,positionKeyupTimeout:null,autoCompleteKeyupDelay:500,positionKeyupDelay:500,defaultZoom:15,maxZoom:17,defaultCenter:{lat:35.744989,lng:51.375284},cedarMapJsLib:"https://api.cedarmaps.com/cedarmaps.js/v1.8.0/cedarmaps.js",cedarMapCssLib:"https://api.cedarmaps.com/cedarmaps.js/v1.8.0/cedarmaps.css",cedarMapTilesSource:"https://alopeyk.api.cedarmaps.com/v1/tiles/cedarmaps.streets.json?access_token={{TOKEN}}"}},A.wcshm.public.fn={addPrefix:function(a){for(var s=[],t=a.split(" "),e=0;e<t.length;e++)s.push(A.wcshm.public.vars.common.alopeykPrefix+t[e]);return s.join(" ")},injectScript:function(a,s){var t,e;M('[src="'+a+'"]').length||((t=document.createElement("script")).type="text/javascript",t.async=!0,t.src=a,t.onload=s||!1,(e=document.getElementsByTagName("script")[0]).parentNode.insertBefore(t,e))},injectStylesheet:function(a){var s,t;M('[href="'+a+'"]').length||((s=document.createElement("link")).type="text/css",s.rel="stylesheet",s.href=a,(t=document.getElementsByTagName("link")[0]).parentNode.insertBefore(s,t))},loadCedarMaps:function(){window.alopeykHandleMapsPublic=A.wcshm.public.fn.handleMaps,"function"==typeof alopeykHandleMapsPublic&&(void 0!==window.L?(window.cedarMapIsLoading=!1,A.wcshm.public.fn.handleMaps()):window.cedarMapIsLoading?A.wcshm.public.vars.loadingMapInterval=setInterval(function(){window.L&&(window.cedarMapIsLoading=!1,clearInterval(A.wcshm.public.vars.loadingMapInterval),A.wcshm.public.fn.handleMaps())},500):(window.cedarMapIsLoading=!0,A.wcshm.public.fn.injectScript(A.wcshm.public.vars.maps.cedarMapJsLib,alopeykHandleMapsPublic),A.wcshm.public.fn.injectStylesheet(A.wcshm.public.vars.maps.cedarMapCssLib)))},handleMaps:function(){M(document).trigger("alopeyk:public:map:loaded")},initMaps:function(){M(document).on("alopeyk:public:map:loaded",function(){var a=M(A.wcshm.public.vars.maps.destinationLatInput),s=M(A.wcshm.public.vars.maps.destinationLngInput),t=M(A.wcshm.public.vars.maps.destinationCityInput),e=M(A.wcshm.public.vars.maps.destinationAddressInput),n=M(A.wcshm.public.vars.maps.destinationNumberInput),i=M(A.wcshm.public.vars.maps.destinationUnitInput),c=M(A.wcshm.public.vars.maps.shippingAddress1Input),o=M(A.wcshm.public.vars.maps.shippingAddress2Input),p=M(A.wcshm.public.vars.maps.billingAddress1Input),l=M(A.wcshm.public.vars.maps.billingAddress2Input),r=M(A.wcshm.public.vars.maps.shipToDifferentAddressInput),u=M(A.wcshm.public.vars.maps.editAddressButton);a.length&&s.length&&t.length&&e.length&&A.wcshm.public.fn.initDestinationLocator(a,s,t,e,n,i,c,o,p,l,r,u)}),A.wcshm.public.fn.loadCedarMaps()},setCurrentGeolocation:function(a){var s=A.wcshm.public.vars.common.destinationMap,t=s?s.mapObject:null,e=M(A.wcshm.public.vars.maps.destinationLatInput),n=M(A.wcshm.public.vars.maps.destinationLngInput);navigator.geolocation&&t&&e.length&&n.length&&(a||!e.val().length&&!n.val().length||e.val()==A.wcshm.public.vars.maps.defaultCenter.lat&&destinationngInput.val()==A.wcshm.public.vars.maps.defaultCenter.lng)&&navigator.geolocation.getCurrentPosition(function(a){A.wcshm.public.vars.maps.fetchAddressConnection&&A.wcshm.public.vars.maps.fetchAddressConnection.abort(),t.setView({lat:a.coords.latitude,lng:a.coords.longitude}),A.wcshm.public.vars.maps.defaultCenter.lat=a.coords.latitude,A.wcshm.public.vars.maps.defaultCenter.lng=a.coords.longitude,e.val(a.coords.latitude),n.val(a.coords.longitude).trigger("change")})},initDestinationLocator:function(h,v,b,w,f,g,y,C,_,I,k,a){var s=function(){var a=A.wcshm.public.vars.common.info.alopeyk.wcshm.map.marker,s=M("<div/>").attr({id:A.wcshm.public.fn.addPrefix(A.wcshm.public.vars.maps.destinationLocatorMapId),class:A.wcshm.public.fn.addPrefix(A.wcshm.public.vars.maps.destinationLocatorMapClass)}),c=w.clone().attr({id:w.attr("id")+"_autocomplete",class:w.attr("class"),placeholder:w.data(A.wcshm.public.vars.maps.autocompletePlaceholderDataAttr),name:"",style:"",type:"text",spellcheck:"false",autocapitalize:"off",autocorrect:"off",autocomplete:"off"}).removeClass(A.wcshm.public.vars.common.disabledClass),t=M("<div>").attr({id:A.wcshm.public.fn.addPrefix(A.wcshm.public.vars.maps.destinationLocatorInputWrapperId),class:A.wcshm.public.fn.addPrefix(A.wcshm.public.vars.maps.destinationLocatorInputWrapperClass)}),o=M("<ul/>").attr({id:A.wcshm.public.fn.addPrefix(A.wcshm.public.vars.maps.destinationLocatorAutocompleteResultsClass),class:A.wcshm.public.fn.addPrefix(A.wcshm.public.vars.maps.destinationLocatorAutocompleteResultsClass)}),e=M("<div/>").attr({class:A.wcshm.public.fn.addPrefix(A.wcshm.public.vars.maps.mapContainerClass)}),n=M("<button/>").attr({type:"button",class:A.wcshm.public.fn.addPrefix(A.wcshm.public.vars.maps.destinationLocatorCtaClass)}),i=M("<img/>").attr({src:a,class:A.wcshm.public.fn.addPrefix(A.wcshm.public.vars.maps.mapMarkerIconClass)});t.insertAfter(w).append(c).append(o),s.insertAfter(t),e.insertAfter(s),e.append(s).append(t).append(n).prepend(i),L.cedarmaps.accessToken=A.wcshm.public.vars.common.info.alopeyk.wcshm.map.api_key;var p={zoom:A.wcshm.public.vars.maps.defaultZoom,maxZoom:A.wcshm.public.vars.maps.maxZoom,center:[h.val().length?parseFloat(h.val()):A.wcshm.public.vars.maps.defaultCenter.lat,v.val().length?parseFloat(v.val()):A.wcshm.public.vars.maps.defaultCenter.lng],zoomControl:!1,scrollWheelZoom:!1},l=L.cedarmaps.map(s.get(0),A.wcshm.public.vars.maps.cedarMapTilesSource.replace("{{TOKEN}}",L.cedarmaps.accessToken),p),r=function(a){var s=o.children(),t=a==s.length?0:a<0?s.length-1:a,e=A.wcshm.public.vars.common.activeClass;s.removeClass(e).eq(t).addClass(e)},u=function(){A.wcshm.public.vars.maps.fetchAddressConnection&&A.wcshm.public.vars.maps.fetchAddressConnection.abort(),t.addClass(A.wcshm.public.vars.common.loadingClass),A.wcshm.public.vars.maps.fetchAddressConnection=M.post(A.wcshm.public.vars.common.info.ajaxOptions.url,{nonce:A.wcshm.public.vars.common.info.ajaxOptions.nonce,action:A.wcshm.public.vars.common.info.alopeyk.wcshm.id,request:"get_address",authenticate:!0,ask_cedar:!0,lat:l.getCenter().lat,lng:l.getCenter().lng},function(a){if(a){o.empty(),b.val(a.success&&a.data.city?a.data.city:""),c.val(a.data.address);var s=a.success?a.data.address:"";w.val(s).trigger("change"),y.val(s),C.val(""),k.length&&!k.prop("checked")&&(_.length&&_.val(s),I.length&&I.val(""))}}).always(function(){t.removeClass(A.wcshm.public.vars.common.loadingClass)})},m=function(s){A.wcshm.public.vars.updateShipingMethod&&A.wcshm.public.vars.updateShipingMethod.abort(),w.parents("form").find('button, input[type="button"], input[type="submit"]').filter(function(){return!M(this).is(":disabled")}).prop("disabled",!0).data("alopeyk-disable",!0),A.wcshm.public.vars.updateShipingMethod=M.post(A.wcshm.public.vars.common.info.ajaxOptions.url,{nonce:A.wcshm.public.vars.common.info.ajaxOptions.nonce,action:A.wcshm.public.vars.common.info.alopeyk.wcshm.id,request:"set_session",authenticate:!0,lat:l.getCenter().lat,lng:l.getCenter().lng,city:b.val(),address:w.val(),number:f.val(),unit:g.val(),payment_method:M(d+":checked").val()},function(a){a&&a.success&&s&&M("body").trigger("update_checkout"),w.parents("form").find('button, input[type="button"], input[type="submit"]').filter(function(){return M(this).data("alopeyk-disable")}).prop("disabled",!1)})},d=A.wcshm.public.vars.common.paymentMethodInput;L.control.zoom({position:"bottomright"}).addTo(l),A.wcshm.public.vars.common.destinationMap={mapObject:l},A.wcshm.public.vars.common.info.woocommerce.checkout&&(M(document).on("change",d+", #"+w.attr("id"),function(){m(!0)}),M.merge(f,g).on("change paste keyup input propertychange",function(){A.wcshm.public.vars.maps.addressDetailKeyupTimeout&&clearTimeout(A.wcshm.public.vars.maps.addressDetailKeyupTimeout),A.wcshm.public.vars.maps.addressDetailKeyupTimeout=setTimeout(function(){m(!1)},A.wcshm.public.vars.maps.autoCompleteKeyupDelay)})),l.on("move",function(){h.val(l.getCenter().lat),v.val(l.getCenter().lng)}),l.on("dragend",function(){u()}),M.merge(h,v).on("change paste keyup input propertychange",function(){A.wcshm.public.vars.maps.latitudeValue==h.val()&&A.wcshm.public.vars.maps.longitudeValue==v.val()||(A.wcshm.public.vars.maps.latitudeValue=h.val(),A.wcshm.public.vars.maps.longitudeValue=v.val(),A.wcshm.public.vars.maps.positionKeyupTimeout&&clearTimeout(A.wcshm.public.vars.maps.positionKeyupTimeout),A.wcshm.public.vars.maps.positionKeyupTimeout=setTimeout(function(){var a={lat:parseFloat(h.val()),lng:parseFloat(v.val())};l.setView(a),u()},A.wcshm.public.vars.maps.positionKeyupDelay))}),k.on("change",function(){var a=M(this).prop("checked"),s=a?"":"none";_.parent().css("display",s),I.parent().css("display",s),a||(_.val(y.val()),I.val(C.val()))}).trigger("change"),c.on({keydown:function(a){var s=o.children("."+A.wcshm.public.vars.common.activeClass),t=s.length?s.index():-1;switch(a.which){case 13:a.preventDefault(),s&&s.trigger("click");break;case 27:c.blur();break;case 38:a.preventDefault(),r(t-1);break;case 40:a.preventDefault(),r(t+1)}},"change paste keyup input propertychange":function(a){A.wcshm.public.vars.maps.autocompleteInputValue!=c.val()&&(o.empty(),A.wcshm.public.vars.maps.autocompleteInputValue=c.val(),A.wcshm.public.vars.maps.autocompleteKeyupTimeout&&clearTimeout(A.wcshm.public.vars.maps.autocompleteKeyupTimeout),A.wcshm.public.vars.maps.autocompleteKeyupTimeout=setTimeout(function(){A.wcshm.public.vars.maps.autocompleteConnection&&A.wcshm.public.vars.maps.autocompleteConnection.abort(),t.addClass(A.wcshm.public.vars.common.loadingClass),A.wcshm.public.vars.maps.autocompleteConnection=M.post(A.wcshm.public.vars.common.info.ajaxOptions.url,{nonce:A.wcshm.public.vars.common.info.ajaxOptions.nonce,action:A.wcshm.public.vars.common.info.alopeyk.wcshm.id,request:"suggest_address",authenticate:!0,input:c.val()},function(a){if(a&&a.success&&a.data.length){c.focus();for(var s=0;s<a.data.length;s++){var t={lat:parseFloat(a.data[s].lat),lng:parseFloat(a.data[s].lng)},e=a.data[s].address,n=a.data[s].city,i=M("<li>").addClass(A.wcshm.public.fn.addPrefix(A.wcshm.public.vars.maps.destinationLocatorAutocompleteResultClass)).attr("title",e).data({city:n,address:e,location:t}).text(e).on({click:function(){var a=M(this).data("city"),s=M(this).data("address"),t=M(this).data("location");c.blur(),c.val(s),w.val(s),b.val(a),l.setView(t),l.setZoom(A.wcshm.public.vars.maps.defaultZoom),h.val(t.lat),v.val(t.lng),A.wcshm.public.vars.maps.autocompleteInputValue=s,y.val(s),C.val(""),k.length&&!k.prop("checked")&&(_.length&&_.val(s),I.length&&I.val("")),u()},hover:function(){r(M(this).index())}});o.append(i)}}}).always(function(){t.removeClass(A.wcshm.public.vars.common.loadingClass)})},A.wcshm.public.vars.maps.autoCompleteKeyupDelay))}}),n.on("click",function(){A.wcshm.public.fn.setCurrentGeolocation(!0)}),A.wcshm.public.fn.setCurrentGeolocation()};a.length&&a.is(":visible")?a.on("click",function(){s()}):s()},init:function(){}},M(document).on({ready:function(a){A.wcshm.public.fn.init()}}),M(window).on({load:function(a){A.wcshm.public.fn.initMaps()}})}(jQuery);